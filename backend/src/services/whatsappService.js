// ===========================
// backend/src/services/WhatsAppService.js (3/4)
// ===========================
const axios = require('axios');
const logger = require('../utils/logger');

class WhatsAppService {
  constructor() {
    this.apiUrl = process.env.WHATSAPP_API_URL || 'https://graph.facebook.com/v18.0';
    this.accessToken = process.env.WHATSAPP_ACCESS_TOKEN;
    this.phoneNumberId = process.env.WHATSAPP_PHONE_NUMBER_ID;
    this.businessAccountId = process.env.WHATSAPP_BUSINESS_ACCOUNT_ID;
  }

  // Verificar se WhatsApp est√° configurado
  isConfigured() {
    return !!(this.accessToken && this.phoneNumberId);
  }

  // Enviar mensagem de texto
  async sendTextMessage(to, message) {
    try {
      if (!this.isConfigured()) {
        logger.warn('WhatsApp n√£o configurado, pulando envio de mensagem');
        return { success: false, reason: 'not_configured' };
      }

      const url = `${this.apiUrl}/${this.phoneNumberId}/messages`;
      
      const payload = {
        messaging_product: 'whatsapp',
        to: this.formatPhoneNumber(to),
        type: 'text',
        text: {
          body: message
        }
      };

      const response = await axios.post(url, payload, {
        headers: {
          'Authorization': `Bearer ${this.accessToken}`,
          'Content-Type': 'application/json'
        }
      });

      logger.info(`Mensagem WhatsApp enviada para ${to}:`, response.data);
      
      return {
        success: true,
        message_id: response.data.messages[0].id,
        whatsapp_id: response.data.messages[0].whatsapp_id
      };
    } catch (error) {
      logger.error('Erro ao enviar mensagem WhatsApp:', {
        to,
        error: error.response?.data || error.message
      });
      
      return {
        success: false,
        error: error.response?.data || error.message
      };
    }
  }

  // Enviar confirma√ß√£o de agendamento
  async sendBookingConfirmation(booking) {
    try {
      const { customer, professional, service, company } = booking;
      
      if (!customer.phone) {
        return { success: false, reason: 'no_phone' };
      }

      const message = `üéâ *Agendamento Confirmado!*

üìÖ *Data:* ${this.formatDate(booking.booking_date)}
üïí *Hor√°rio:* ${booking.start_time.substring(0, 5)}
üíá‚Äç‚ôÄÔ∏è *Servi√ßo:* ${service.name}
üë®‚Äçüíº *Profissional:* ${professional.name}
üí∞ *Valor:* R$ ${booking.final_price.toFixed(2).replace('.', ',')}

üìç *Local:*
${company.name}
${company.address || 'Endere√ßo n√£o informado'}

üìû *Contato:* ${company.phone || company.whatsapp}

_Precisando remarcar ou cancelar, entre em contato at√© 2 horas antes do hor√°rio._

Obrigado por escolher nossos servi√ßos! ‚ú®`;

      return await this.sendTextMessage(customer.phone, message);
    } catch (error) {
      logger.error('Erro ao enviar confirma√ß√£o WhatsApp:', error);
      return { success: false, error: error.message };
    }
  }

  // Enviar lembrete de agendamento
  async sendBookingReminder(booking) {
    try {
      const { customer, professional, service, company } = booking;
      
      if (!customer.phone) {
        return { success: false, reason: 'no_phone' };
      }

      const message = `‚è∞ *Lembrete de Agendamento*

Ol√° ${customer.name}! 

Voc√™ tem um agendamento *amanh√£*:

üìÖ ${this.formatDate(booking.booking_date)}
üïí ${booking.start_time.substring(0, 5)}
üíá‚Äç‚ôÄÔ∏è ${service.name}
üë®‚Äçüíº ${professional.name}

üìç ${company.name}
${company.address || ''}

Nos vemos em breve! üòä`;

      return await this.sendTextMessage(customer.phone, message);
    } catch (error) {
      logger.error('Erro ao enviar lembrete WhatsApp:', error);
      return { success: false, error: error.message };
    }
  }

  // Enviar cancelamento de agendamento
  async sendBookingCancellation(booking) {
    try {
      const { customer, service } = booking;
      
      if (!customer.phone) {
        return { success: false, reason: 'no_phone' };
      }

      const message = `‚ùå *Agendamento Cancelado*

Ol√° ${customer.name},

Seu agendamento foi cancelado:

üìÖ ${this.formatDate(booking.booking_date)}
üïí ${booking.start_time.substring(0, 5)}
üíá‚Äç‚ôÄÔ∏è ${service.name}

${booking.cancellation_reason ? `*Motivo:* ${booking.cancellation_reason}` : ''}

Para reagendar, entre em contato conosco! üìû`;

      return await this.sendTextMessage(customer.phone, message);
    } catch (error) {
      logger.error('Erro ao enviar cancelamento WhatsApp:', error);
      return { success: false, error: error.message };
    }
  }

  // Enviar mensagem com template
  async sendTemplateMessage(to, templateName, languageCode = 'pt_BR', components = []) {
    try {
      if (!this.isConfigured()) {
        return { success: false, reason: 'not_configured' };
      }

      const url = `${this.apiUrl}/${this.phoneNumberId}/messages`;
      
      const payload = {
        messaging_product: 'whatsapp',
        to: this.formatPhoneNumber(to),
        type: 'template',
        template: {
          name: templateName,
          language: {
            code: languageCode
          },
          components: components
        }
      };

      const response = await axios.post(url, payload, {
        headers: {
          'Authorization': `Bearer ${this.accessToken}`,
          'Content-Type': 'application/json'
        }
      });

      logger.info(`Template WhatsApp enviado para ${to}:`, response.data);
      
      return {
        success: true,
        message_id: response.data.messages[0].id
      };
    } catch (error) {
      logger.error('Erro ao enviar template WhatsApp:', error);
      return { success: false, error: error.response?.data || error.message };
    }
  }

  // Marcar mensagem como lida
  async markAsRead(messageId) {
    try {
      if (!this.isConfigured()) {
        return { success: false, reason: 'not_configured' };
      }

      const url = `${this.apiUrl}/${this.phoneNumberId}/messages`;
      
      const payload = {
        messaging_product: 'whatsapp',
        status: 'read',
        message_id: messageId
      };

      await axios.post(url, payload, {
        headers: {
          'Authorization': `Bearer ${this.accessToken}`,
          'Content-Type': 'application/json'
        }
      });

      return { success: true };
    } catch (error) {
      logger.error('Erro ao marcar mensagem como lida:', error);
      return { success: false, error: error.message };
    }
  }

  // Obter perfil do business
  async getBusinessProfile() {
    try {
      if (!this.isConfigured()) {
        return { success: false, reason: 'not_configured' };
      }

      const url = `${this.apiUrl}/${this.phoneNumberId}/whatsapp_business_profile`;
      
      const response = await axios.get(url, {
        headers: {
          'Authorization': `Bearer ${this.accessToken}`
        }
      });

      return {
        success: true,
        profile: response.data.data[0]
      };
    } catch (error) {
      logger.error('Erro ao obter perfil WhatsApp Business:', error);
      return { success: false, error: error.message };
    }
  }

  // Atualizar perfil do business
  async updateBusinessProfile(profileData) {
    try {
      if (!this.isConfigured()) {
        return { success: false, reason: 'not_configured' };
      }

      const url = `${this.apiUrl}/${this.phoneNumberId}/whatsapp_business_profile`;
      
      const response = await axios.post(url, profileData, {
        headers: {
          'Authorization': `Bearer ${this.accessToken}`,
          'Content-Type': 'application/json'
        }
      });

      return { success: true, data: response.data };
    } catch (error) {
      logger.error('Erro ao atualizar perfil WhatsApp Business:', error);
      return { success: false, error: error.message };
    }
  }

  // Formatar n√∫mero de telefone para padr√£o internacional
  formatPhoneNumber(phone) {
    // Remove todos os caracteres n√£o num√©ricos
    let cleaned = phone.replace(/\D/g, '');
    
    // Se come√ßar com 0, remove o 0
    if (cleaned.startsWith('0')) {
      cleaned = cleaned.substring(1);
    }
    
    // Se n√£o come√ßar com 55 (c√≥digo do Brasil), adiciona
    if (!cleaned.startsWith('55')) {
      cleaned = '55' + cleaned;
    }
    
    return cleaned;
  }

  // Formatar data para portugu√™s
  formatDate(date) {
    const options = {
      weekday: 'long',
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    };
    
    return new Date(date).toLocaleDateString('pt-BR', options);
  }

  // Processar mensagem recebida
  async processIncomingMessage(message, metadata) {
    try {
      logger.info('Processando mensagem WhatsApp recebida:', {
        from: message.from,
        type: message.type,
        timestamp: message.timestamp
      });

      // Marcar como lida
      await this.markAsRead(message.id);

      // Processar diferentes tipos de mensagem
      switch (message.type) {
        case 'text':
          await this.processTextMessage(message);
          break;
        case 'button':
          await this.processButtonMessage(message);
          break;
        case 'interactive':
          await this.processInteractiveMessage(message);
          break;
        default:
          logger.info(`Tipo de mensagem n√£o suportado: ${message.type}`);
      }

      return { success: true };
    } catch (error) {
      logger.error('Erro ao processar mensagem recebida:', error);
      return { success: false, error: error.message };
    }
  }

  // Processar mensagem de texto
  async processTextMessage(message) {
    const messageText = message.text.body.toLowerCase().trim();
    const phoneNumber = message.from;

    // Respostas autom√°ticas simples
    if (messageText.includes('oi') || messageText.includes('ol√°') || messageText.includes('ola')) {
      await this.sendTextMessage(phoneNumber, 
        `Ol√°! üëã Bem-vindo ao nosso atendimento pelo WhatsApp!\n\nPara agendar um hor√°rio, acesse: ${process.env.APP_URL}\n\nOu digite *AJUDA* para ver as op√ß√µes dispon√≠veis.`
      );
    } else if (messageText.includes('ajuda') || messageText.includes('menu')) {
      await this.sendTextMessage(phoneNumber,
        `üîπ *MENU DE OP√á√ïES* üîπ\n\n1Ô∏è‚É£ Digite *AGENDAR* para fazer um agendamento\n2Ô∏è‚É£ Digite *HORARIOS* para ver hor√°rios dispon√≠veis\n3Ô∏è‚É£ Digite *SERVICOS* para ver nossos servi√ßos\n4Ô∏è‚É£ Digite *CONTATO* para falar com atendente\n\nOu acesse nosso site: ${process.env.APP_URL}`
      );
    } else if (messageText.includes('agendar')) {
      await this.sendTextMessage(phoneNumber,
        `üìÖ *AGENDAMENTO ONLINE*\n\nPara agendar seu hor√°rio de forma r√°pida e pr√°tica, acesse nosso site:\n\nüîó ${process.env.APP_URL}\n\nL√° voc√™ pode:\n‚úÖ Escolher o servi√ßo\n‚úÖ Selecionar o profissional\n‚úÖ Verificar hor√°rios dispon√≠veis\n‚úÖ Confirmar agendamento\n\n√â r√°pido e f√°cil! üòä`
      );
    } else if (messageText.includes('contato')) {
      await this.sendTextMessage(phoneNumber,
        `üìû *FALE CONOSCO*\n\nPara atendimento personalizado:\n\nüì± WhatsApp: ${process.env.WHATSAPP_PHONE || 'Este n√∫mero'}\nüìß Email: ${process.env.SMTP_USER}\n\nHor√°rio de atendimento:\nSegunda a Sexta: 8h √†s 18h\nS√°bado: 8h √†s 16h\n\nAguardamos seu contato! ‚ú®`
      );
    } else {
      // Resposta padr√£o para mensagens n√£o reconhecidas
      await this.sendTextMessage(phoneNumber,
        `Obrigado pela sua mensagem! üòä\n\nPara um atendimento mais r√°pido, digite *AJUDA* para ver o menu de op√ß√µes.\n\nOu acesse nosso site para agendamentos: ${process.env.APP_URL}`
      );
    }
  }

  // Processar mensagem de bot√£o
  async processButtonMessage(message) {
    const buttonText = message.button.text;
    const phoneNumber = message.from;

    logger.info(`Bot√£o pressionado: ${buttonText} por ${phoneNumber}`);
    
    // Implementar l√≥gica baseada no bot√£o pressionado
    await this.sendTextMessage(phoneNumber, 
      `Voc√™ selecionou: ${buttonText}\n\nEm breve implementaremos esta funcionalidade! üöÄ`
    );
  }

  // Processar mensagem interativa
  async processInteractiveMessage(message) {
    const interactiveType = message.interactive.type;
    const phoneNumber = message.from;

    logger.info(`Mensagem interativa recebida: ${interactiveType} de ${phoneNumber}`);
    
    if (interactiveType === 'list_reply') {
      const listId = message.interactive.list_reply.id;
      await this.sendTextMessage(phoneNumber, 
        `Voc√™ selecionou a op√ß√£o: ${listId}\n\nEm breve implementaremos esta funcionalidade! üöÄ`
      );
    }
  }
}

module.exports = new WhatsAppService();